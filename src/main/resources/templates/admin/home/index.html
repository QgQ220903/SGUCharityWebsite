<!DOCTYPE html>
<html lang="en">

<head th:replace="admin/fragments/head :: head"></head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">

        <nav th:replace="admin/fragments/nav :: nav"></nav>

        <aside th:replace="admin/fragments/aside :: aside"></aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">Thống Kê</h1>
                        </div><!-- /.col -->
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Trang Chủ</a></li>
                                <li class="breadcrumb-item active">Thống Kê</li>
                            </ol>
                        </div><!-- /.col -->
                    </div><!-- /.row -->
                </div><!-- /.container-fluid -->
            </div>
            <!-- /.content-header -->

            <!-- Main content -->
            <div class="content">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-4 col-6">
                            <!-- small box -->
                            <div class="small-box bg-danger">
                                <div class="inner">
                                    <h3 id="countProject">0</h3>
                                    <p>Tổng Số Dự Án</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-pie-graph"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-6">
                            <!-- small box -->
                            <div class="small-box bg-warning">
                                <div class="inner">
                                    <h3 id="countUsers">0</h3>
                                    <p>Tổng Số Người Dùng</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-person-add"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-6">
                            <!-- small box -->
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <h3 id="totalDonation">0</h3>

                                    <p>Tổng Số Tiền Quyên Góp</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h2>Thống kê dự án theo thể loại</h2>
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="w-50 ">
                            <canvas id="myPieChart"></canvas>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Số Lượng Dự Án Theo Danh Mục</h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Danh Mục</th>
                                            <th>Số Lượng Dự Án</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="data : ${projectData}">
                                            <td th:text="${data[0]}"></td>
                                            <td th:text="${data[1]}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>





                    <div class="d-flex gap-2 mt-3 mb-3">
                        <div class="w-100">
                            <h5>Thống kê Số tiền quyên góp theo từng dự án</h5>
                            <canvas id="myBarChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <div class="">
                        <div class="row">
                            <div class="col-lg-12">
                                <h5>Số tiền quyên góp theo thời gian</h5>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label>Từ Ngày:</label>
                                <input id="startDateInput" type="date" class="form-control">
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label>Đến Ngày:</label>
                                <input id="endDateInput" type="date" class="form-control">
                            </div>
                            <div class="col-lg-6 mb-3">
                                <button id="getDonationByTime" class="btn btn-primary">Xem Thống Kê</button>
                            </div>

                        </div>
                        <div class="col-12">
                            <div class="w-100">
                                <canvas id="myLineChart" width="400" height="200"></canvas>
                            </div>
                        </div>

                    </div>




                    <script>
                        // Pie Chart
                        // var ctxPie = document.getElementById('myPieChart').getContext('2d');
                        // var myPieChart = new Chart(ctxPie, {
                        //     type: 'pie', // Chọn loại biểu đồ là Pie
                        //     data: {
                        //         labels: ['Project A', 'Project B', 'Project C', 'Project D'],
                        //         datasets: [{
                        //             data: [300, 500, 100, 700], // Dữ liệu cho các phần của biểu đồ
                        //             backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A1'], // Màu sắc cho từng phần
                        //             borderColor: '#ffffff', // Màu viền
                        //             borderWidth: 2
                        //         }]
                        //     }
                        // });

                        fetch('/api/projects-by-category')
                            .then(response => response.json())

                            .then(data => {
                                // Extract category names and project counts from the API response
                                const labels = data.map(item => item[0]);  // Category names (tên thể loại)
                                const counts = data.map(item => item[1]);  // Number of projects in each category (số lượng dự án)
                                console.log(data);
                                // Tạo biểu đồ tròn (Pie Chart)
                                var ctxPie = document.getElementById('myPieChart').getContext('2d');
                                var myPieChart = new Chart(ctxPie, {
                                    type: 'pie', // Loại biểu đồ là Pie
                                    data: {
                                        labels: labels, // Nhãn cho mỗi phần tử trong biểu đồ (Tên thể loại)
                                        datasets: [{
                                            data: counts, // Số lượng dự án cho mỗi thể loại
                                            backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A1'], // Màu sắc cho các phần
                                            borderColor: '#ffffff', // Màu viền của các phần
                                            borderWidth: 2
                                        }]
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching data:', error);  // Đoạn này giúp kiểm tra lỗi khi fetch dữ liệu
                            });


                        // // Bar Chart
                        // var ctxBar = document.getElementById('myBarChart').getContext('2d');
                        // var myBarChart = new Chart(ctxBar, {
                        //     type: 'bar', // Chọn loại biểu đồ là Bar
                        //     data: {
                        //         labels: ['Project A', 'Project B', 'Project C', 'Project D'],
                        //         datasets: [{
                        //             label: 'Amount Raised ($)', // Tên cho bộ dữ liệu
                        //             data: [1500, 3000, 2000, 3500], // Dữ liệu cho các thanh cột
                        //             backgroundColor: 'rgba(75, 192, 192, 0.2)', // Màu nền cho các thanh
                        //             borderColor: 'rgba(75, 192, 192, 1)', // Màu viền
                        //             borderWidth: 1
                        //         }]
                        //     },
                        //     options: {
                        //         scales: {
                        //             y: {
                        //                 beginAtZero: true // Đảm bảo trục Y bắt đầu từ 0
                        //             }
                        //         }
                        //     }
                        // });

                        // Fetch dữ liệu từ API
                        fetch('/api/projects-amount')
                            .then(response => response.json())
                            .then(data => {
                                // Lấy tên dự án và tổng số tiền từ API response
                                const labels = data.map(item => item[0]);  // Tên dự án
                                const amounts = data.map(item => item[1]); // Số tiền huy động trong mỗi dự án

                                // Vẽ biểu đồ Bar
                                var ctxBar = document.getElementById('myBarChart').getContext('2d');
                                var myBarChart = new Chart(ctxBar, {
                                    type: 'bar', // Biểu đồ cột (Bar)
                                    data: {
                                        labels: labels, // Tên dự án
                                        datasets: [{
                                            label: 'Amount Raised ($)', // Nhãn cho bộ dữ liệu
                                            data: amounts, // Dữ liệu số tiền
                                            backgroundColor: 'rgba(75, 192, 192, 0.2)', // Màu nền của các cột
                                            borderColor: 'rgba(75, 192, 192, 1)', // Màu viền của các cột
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        scales: {
                                            y: {
                                                beginAtZero: true // Đảm bảo trục Y bắt đầu từ 0
                                            }
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching data:', error);  // Xử lý lỗi khi fetch dữ liệu
                            });

                        // Line Chart
                        var ctxLine = document.getElementById('myLineChart').getContext('2d');
                        var myLineChart = new Chart(ctxLine, {
                            type: 'line', // Chọn loại biểu đồ là Line
                            data: {
                                labels: ['January', 'February', 'March', 'April'], // Các mốc thời gian
                                datasets: [{
                                    label: 'Donations Over Time ($)', // Tên cho bộ dữ liệu
                                    data: [500, 1000, 1500, 2000], // Dữ liệu theo thời gian
                                    fill: false, // Không tô màu dưới đường
                                    borderColor: 'rgba(75, 192, 192, 1)', // Màu của đường
                                    tension: 0.1 // Độ cong của đường
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true // Đảm bảo trục Y bắt đầu từ 0
                                    }
                                }
                            }
                        });
                    </script>
                </div><!-- /.container-fluid -->
            </div>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->


        <!-- Main Footer -->
        <footer th:replace="admin/fragments/footer :: footer"></footer>
    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->

    <div th:replace="admin/fragments/script :: script"></div>
    <script th:src="@{/admin/dist/js/home.js}"></script>
    <script>
        function countProjects() {
            $.ajax({
                url: "/api/countAllProjects",
                type: "GET",
                success: function (data) {
                    // Hiển thị số lượng dự án lên thẻ p có id là countProject
                    $("#countProject").text(data);
                },
                error: function (error) {
                    console.error("Lỗi khi lấy dữ liệu: ", error);
                }
            });
        }
        function countUsers() {
            $.ajax({
                url: "/api/countAllUsers",
                type: "GET",
                success: function (data) {
                    // Hiển thị số lượng dự án lên thẻ p có id là countProject
                    $("#countUsers").text(data);
                },
                error: function (error) {
                    console.error("Lỗi khi lấy dữ liệu: ", error);
                }
            });
        }
        function totalDonation() {
            $.ajax({
                url: "/api/total-donation",
                type: "GET",
                success: function (data) {
                    // Hiển thị số lượng dự án lên thẻ p có id là countProject
                    $("#totalDonation").text(data);
                },
                error: function (error) {
                    console.error("Lỗi khi lấy dữ liệu: ", error);
                }
            });
        }

        function getTotalDonationAmount(startDate, endDate) {
            // Thực hiện AJAX request với thời gian bắt đầu và kết thúc được truyền vào hàm
            $.ajax({
                url: '/api/donations/total',
                data: {
                    startDate: startDate + 'T00:00:00',
                    endDate: endDate + 'T23:59:59'
                },
                success: function (data) {
                    // Sử dụng dữ liệu trả về để cập nhật biểu đồ
                    const labels = data.map(item => item.date);
                    const values = data.map(item => item.totalAmount);

                    // Cập nhật dữ liệu cho biểu đồ
                    myLineChart.data.labels = labels;
                    myLineChart.data.datasets[0].data = values;

                    // Cập nhật lại biểu đồ
                    myLineChart.update();
                }
            });
        }
        // // Lắng nghe sự kiện click trên nút có id là 'updateChartButton'
        // document.getElementById('getDonationByTime').addEventListener('click', function () {
        //     // Lấy ngày bắt đầu và kết thúc từ hai input và gọi hàm getTotalDonationAmount
        //     const startDate = document.getElementById('startDateInput').value;
        //     const endDate = document.getElementById('endDateInput').value;
        //     getTotalDonationAmount(startDate, endDate);
        // });
        function convertToIsoString(dateString) {
            const date = new Date(dateString);
            const isoString = date.toISOString().slice(0, 19).replace('T', ' ');
            return isoString;
        }
        // Lắng nghe sự kiện khi nhấn nút xem
        document.getElementById('getDonationByTime').addEventListener('click', function () {
            const startDate = convertToIsoString(document.getElementById('startDateInput').value);
            const endDate = convertToIsoString(document.getElementById('endDateInput').value);

            // Gửi yêu cầu AJAX đến API với các tham số ngày bắt đầu và kết thúc
            $.ajax({
                url: '/api/donations/total',
                method: 'GET',
                data: { startDate: startDate, endDate: endDate },
                success: function (data) {
                    // Cập nhật biểu đồ khi nhận được dữ liệu từ API
                    updateChart(data);
                },
                error: function (err) {
                    console.error('Lỗi khi gửi yêu cầu API: ', err);
                }
            });
        });

        function updateChart(data) {
            // Cập nhật dữ liệu cho biểu đồ
            myLineChart.data.labels = data.labels; // Các nhãn trục x
            myLineChart.data.datasets[0].data = data.values; // Dữ liệu của dataset

            // Vẽ lại biểu đồ
            myLineChart.update();
        }


        countProjects();
        countUsers();
        totalDonation();
    </script>

</body>

</html>